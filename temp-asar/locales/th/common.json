mFtZScpKSB7XG4gICAgICAgICAgICAgICAgbG9nKCfinpUgQWRkaW5nIGNvbHVtbiByb29tVXNlcm5hbWUgdG8gYWNjb3VudHMgdGFibGUnKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRiLmV4ZWMoYEFMVEVSIFRBQkxFIGFjY291bnRzIEFERCBDT0xVTU4gcm9vbVVzZXJuYW1lIFRFWFRgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEtp4buDbSB0cmEgY+G7mXQgY29va2llIHRyb25nIGLhuqNuZyBhY2NvdW50c1xuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbHVtbkV4aXN0cygnYWNjb3VudHMnLCAnY29va2llJykpIHtcbiAgICAgICAgICAgICAgICBsb2coJ+KelSBBZGRpbmcgY29sdW1uIGNvb2tpZSB0byBhY2NvdW50cyB0YWJsZScpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGIuZXhlYyhgQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBjb29raWUgVEVYVGApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBLaeG7g20gdHJhIHhlbSBjw7MgY+G7mXQgdXNlcm5hbWUgdHJvbmcgYuG6o25nIHJvb21zIGtow7RuZyAobOG7l2kgc2NoZW1hIGPFqSlcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbHVtbkV4aXN0cygncm9vbXMnLCAndXNlcm5hbWUnKSAmJiAhdGhpcy5jb2x1bW5FeGlzdHMoJ3Jvb21zJywgJ3Jvb21Vc2VybmFtZScpKSB7XG4gICAgICAgICAgICAgICAgbG9nKCfwn5SEIE1pZ3JhdGluZyBmcm9tIHVzZXJuYW1lIHRvIHJvb21Vc2VybmFtZSBpbiByb29tcyB0YWJsZScpO1xuICAgICAgICAgICAgICAgIC8vIFRow6ptIGPhu5l0IHJvb21Vc2VybmFtZSBt4bubaVxuICAgICAgICAgICAgICAgIHRoaXMuZGIuZXhlYyhgQUxURVIgVEFCTEUgcm9vbXMgQUREIENPTFVNTiByb29tVXNlcm5hbWUgVEVYVGApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFNhbyBjaMOpcCBk4buvIGxp4buHdSB04burIHVzZXJuYW1lIHNhbmcgcm9vbVVzZXJuYW1lXG4gICAgICAgICAgICAgICAgdGhpcy5kYi5leGVjKGBVUERBVEUgcm9vbXMgU0VUIHJvb21Vc2VybmFtZSA9IHVzZXJuYW1lIFdIRVJFIHJvb21Vc2VybmFtZSBJUyBOVUxMIEFORCB1c2VybmFtZSBJUyBOT1QgTlVMTGApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFRoYXkgxJHhu5VpIGluZGV4XG4gICAgICAgICAgICAgICAgdGhpcy5kYi5leGVjKGBEUk9QIElOREVYIElGIEVYSVNUUyBpZHhfcm9vbXNfdXNlcm5hbWVgKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRiLmV4ZWMoYENSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF9yb29tc19yb29tVXNlcm5hbWUgT04gcm9vbXMocm9vbVVzZXJuYW1lKWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBLaeG7g20gdHJhIGPDoWMgdHLGsOG7nW5nIGLhu5Ugc3VuZyB0cm9uZyBi4bqjbmcgcm9vbXNcbiAgICAgICAgICAgIGNvbnN0IGFkZGl0aW9uYWxSb29tQ29sdW1ucyA9IFtcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdpZCcsIHR5cGU6ICdURVhUJyB9LFxuICAgICAgICAgICAgICAgIHsgbmFtZTogJ3Jvb21JZCcsIHR5cGU6ICdURVhUJyB9LFxuICAgICAgICAgICAgICAgIHsgbmFtZTogJ3Jvb21VcmwnLCB0eXBlOiAnVEVYVCcgfSxcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdyb29tVXNlcm5hbWUnLCB0eXBlOiAnVEVYVCcgfSxcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdhdmF0YXJUaHVtYicsIHR5cGU6ICdURVhUJyB9LFxuICAgICAgICAgICAgICAgIHsgbmFtZTogJ3N0YXJ0Q291bnQnLCB0eXBlOiAnSU5URUdFUiBERUZBVUxUIDAnIH0sXG4gICAgICAgICAgICAgICAgeyBuYW1lOiAndGFyZ2V0Vmlld2VycycsIHR5cGU6ICdJTlRFR0VSIERFRkFVTFQgMCcgfSxcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdjdXJyZW50Vmlld2VycycsIHR5cGU6ICdJTlRFR0VSIERFRkFVTFQgMCcgfSxcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdkdXJhdGlvbicsIHR5cGU6ICdJTlRFR0VSIERFRkFVTFQgMzAnIH0sXG4gICAgICAgICAgICAgICAgeyBuYW1lOiAnc3RhdHVzJywgdHlwZTogJ1RFWFQgREVGQVVMVCBcInN0b3BwZWRcIicgfSxcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdzdGFydGVkQXQnLCB0eXBlOiAnVEVYVCcgfSxcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdlbmRlZEF0JywgdHlwZTogJ1RFWFQnIH0sXG4gICAgICAgICAgICAgICAgeyBuYW1lOiAncmVhbFZpZXdlcnMnLCB0eXBlOiAnSU5URUdFUiBERUZBVUxUIDAnIH0sXG4gICAgICAgICAgICAgICAgeyBuYW1lOiAnbGFzdFRpbWVDaGVja1ZpZXdlcnMnLCB0eXBlOiAnVEVYVCcgfSxcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdzdG9wcGVkQXQnLCB0eXBlOiAnVEVYVCcgfSxcbiAgICAgICAgICAgICAgICB7IG5hbWU6ICdzdG9wUmVhc29uJywgdHlwZTogJ1RFWFQnIH0sXG4gICAgICAgICAgICAgICAgeyBuYW1lOiAnZmluYWxEdXJhdGlvbicsIHR5cGU6ICdJTlRFR0VSIERFRkFVTFQgMCcgfVxuICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZm9yIChjb25zdCBjb2x1bW4gb2YgYWRkaXRpb25hbFJvb21Db2x1bW5zKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNvbHVtbkV4aXN0cygncm9vbXMnLCBjb2x1bW4ubmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nKGDinpUgQWRkaW5nIGNvbHVtbiAke2NvbHVtbi5uYW1lfSB0byByb29tcyB0YWJsZWApO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLmV4ZWMoYEFMVEVSIFRBQkxFIHJvb21zIEFERCBDT0xVTU4gJHtjb2x1bW4ubmFtZX0gJHtjb2x1bW4udHlwZX1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEPhuq1wIG5o4bqtdCBjw6FjIGNvbnN0cmFpbnQgY2hvIHRy4bqhbmcgdGjDoWlcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgLy8gS2nhu4NtIHRyYSDEkeG7i25oIG5naMSpYSBjb25zdHJhaW50IHN0YXR1cyB0cm9uZyBi4bqjbmcgcHJveGllc1xuICAgICAgICAgICAgICAgIGNvbnN0IHByb3h5U3RhdHVzSW5mbyA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICAgICAgICAgICAgICAgIFNFTEVDVCBzcWwgRlJPTSBzcWxpdGVfbWFzdGVyIFxuICAgICAgICAgICAgICAgICAgICBXSEVSRSB0eXBlPSd0YWJsZScgQU5EIG5hbWU9J3Byb3hpZXMnXG4gICAgICAgICAgICAgICAgYCkuZ2V0KCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gTuG6v3Uga2jDtG5nIGPDsyBjb25zdHJhaW50ICdhY3RpdmUnIHRow6wgdGjDqm0gdsOgb1xuICAgICAgICAgICAgICAgIGlmIChwcm94eVN0YXR1c0luZm8gJiYgcHJveHlTdGF0dXNJbmZvLnNxbCAmJiBcbiAgICAgICAgICAgICAgICAgICAgIXByb3h5U3RhdHVzSW5mby5zcWwuaW5jbHVkZXMoXCInYWN0aXZlJ1wiKSAmJiBcbiAgICAgICAgICAgICAgICAgICAgcHJveHlTdGF0dXNJbmZvLnNxbC5pbmNsdWRlcyhcInN0YXR1cyBURVhUXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZygn8J+UhCBSZWNyZWF0aW5nIHByb3hpZXMgdGFibGUgd2l0aCB1cGRhdGVkIHN0YXR1cyBjb25zdHJhaW50Jyk7XG4gICAgICAgICAgICAgICAgICAgIC8vIEzGsHUgZOG7ryBsaeG7h3UgaGnhu4duIHThuqFpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGIuZXhlYyhgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgcHJveGllc190ZW1wIEFTIFNFTEVDVCAqIEZST00gcHJveGllc2ApO1xuICAgICAgICAgICAgICAgICAgICAvLyBYw7NhIGLhuqNuZyBjxalcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi5leGVjKGBEUk9QIFRBQkxFIHByb3hpZXNgKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gVOG6oW8gbOG6oWkgYuG6o25nIHbhu5tpIGNvbnN0cmFpbnQgbeG7m2lcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi5leGVjKGBcbiAgICAgICAgICAgICAgICAgICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHByb3hpZXMgKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkIFRFWFQgUFJJTUFSWSBLRVksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9zdCBURVhUIE5PVCBOVUxMLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcnQgSU5URUdFUiBOT1QgTlVMTCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSBURVhULFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkIFRFWFQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSBURVhUIERFRkFVTFQgJ2h0dHAnIENIRUNLICh0eXBlIElOICgnaHR0cCcsICdodHRwcycsICdzb2NrczQnLCAnc29ja3M1JykpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbGRlcklkIFRFWFQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzIFRFWFQgREVGQVVMVCAnYWN0aXZlJyBDSEVDSyAoc3RhdHVzIElOICgnYWN0aXZlJywgJ2luYWN0aXZlJywgJ2Vycm9yJywgJ3Rlc3RpbmcnLCAndW5rbm93bicpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0VGVzdGVkIFRFWFQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VUaW1lIElOVEVHRVIgREVGQVVMVCAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGVzIFRFWFQgREVGQVVMVCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkQXQgVEVYVCBOT1QgTlVMTCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkQXQgVEVYVCBOT1QgTlVMTCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGT1JFSUdOIEtFWSAoZm9sZGVySWQpIFJFRkVSRU5DRVMgZm9sZGVycyhpZCkgT04gREVMRVRFIFNFVCBOVUxMLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVOSVFVRShob3N0LCBwb3J0KVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICBgKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gS2jDtGkgcGjhu6VjIGThu68gbGnhu4d1XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGIuZXhlYyhgSU5TRVJUIElOVE8gcHJveGllcyBTRUxFQ1QgKiBGUk9NIHByb3hpZXNfdGVtcGApO1xuICAgICAgICAgICAgICAgICAgICAvLyBYw7NhIGLhuqNuZyB04bqhbVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLmV4ZWMoYERST1AgVEFCTEUgcHJveGllc190ZW1wYCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEtp4buDbSB0cmEgxJHhu4tuaCBuZ2jEqWEgY29uc3RyYWludCBzdGF0dXMgdHJvbmcgYuG6o25nIGFjY291bnRzXG4gICAgICAgICAgICAgICAgY29uc3QgYWNjb3VudFN0YXR1c0luZm8gPSB0aGlzLmRiLnByZXBhcmUoYFxuICAgICAgICAgICAgICAgICAgICBTRUxFQ1Qgc3FsIEZST00gc3FsaXRlX21hc3RlciBcbiAgICAgICAgICAgICAgICAgICAgV0hFUkUgdHlwZT0ndGFibGUnIEFORCBuYW1lPSdhY2NvdW50cydcbiAgICAgICAgICAgICAgICBgKS5nZXQoKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoYWNjb3VudFN0YXR1c0luZm8gJiYgYWNjb3VudFN0YXR1c0luZm8uc3FsICYmIFxuICAgICAgICAgICAgICAgICAgICAhYWNjb3VudFN0YXR1c0luZm8uc3FsLmluY2x1ZGVzKFwiJ2FjdGl2ZSdcIikgJiYgXG4gICAgICAgICAgICAgICAgICAgIGFjY291bnRTdGF0dXNJbmZvLnNxbC5pbmNsdWRlcyhcInN0YXR1cyBURVhUXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZygn8J+UhCBSZWNyZWF0aW5nIGFjY291bnRzIHRhYmxlIHdpdGggdXBkYXRlZCBzdGF0dXMgY29uc3RyYWludCcpO1xuICAgICAgICAgICAgICAgICAgICAvLyBMxrB1IGThu68gbGnhu4d1IGhp4buHbiB04bqhaVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLmV4ZWMoYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGFjY291bnRzX3RlbXAgQVMgU0VMRUNUICogRlJPTSBhY2NvdW50c2ApO1xuICAgICAgICAgICAgICAgICAgICAvLyBYw7NhIGLhuqNuZyBjxalcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi5leGVjKGBEUk9QIFRBQkxFIGFjY291bnRzYCk7XG4gICAgICAgICAgICAgICAgICAgIC8vIFThuqFvIGzhuqFpIGLhuqNuZyB24bubaSBjb25zdHJhaW50IG3hu5tpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlVGFibGVzKCk7IC8vIFThuqFvIGzhuqFpIHThuqV0IGPhuqMgdGFibGVzXG4gICAgICAgICAgICAgICAgICAgIC8vIEtow7RpIHBo4bulYyBk4buvIGxp4buHdVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLmV4ZWMoYFxuICAgICAgICAgICAgICAgICAgICAgICAgSU5TRVJUIE9SIElHTk9SRSBJTlRPIGFjY291bnRzIFxuICAgICAgICAgICAgICAgICAgICAgICAgU0VMRUNUICogRlJPTSBhY2NvdW50c190ZW1wXG4gICAgICAgICAgICAgICAgICAgIGApO1xuICAgICAgICAgICAgICAgICAgICAvLyBYw7NhIGLhuqNuZyB04bqhbVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLmV4ZWMoYERST1AgVEFCTEUgYWNjb3VudHNfdGVtcGApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgZXJyb3IoJ+KdjCBFcnJvciB1cGRhdGluZyBjb25zdHJhaW50czonLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxvZygn4pyFIERhdGFiYXNlIHNjaGVtYSBtaWdyYXRpb24gY29tcGxldGVkIHN1Y2Nlc3NmdWxseScpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBlcnJvcign4p2MIEVycm9yIG1pZ3JhdGluZyBkYXRhYmFzZSBzY2hlbWE6JywgZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogS2nhu4NtIHRyYSB4ZW0gY+G7mXQgY8OzIHThu5NuIHThuqFpIHRyb25nIGLhuqNuZyBraMO0bmdcbiAgICAgKi9cbiAgICBjb2x1bW5FeGlzdHModGFibGUsIGNvbHVtbikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5kYi5wcmVwYXJlKGBQUkFHTUEgdGFibGVfaW5mbygke3RhYmxlfSlgKS5hbGwoKTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQuc29tZShjb2wgPT4gY29sLm5hbWUgPT09IGNvbHVtbik7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBlcnJvcihg4p2MIEVycm9yIGNoZWNraW5nIGlmIGNvbHVtbiAke2NvbHVtbn0gZXhpc3RzIGluICR7dGFibGV9OmAsIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBkYXRhYmFzZSBpbmZvXG4gICAgICovXG4gICAgZ2V0RGF0YWJhc2VJbmZvKCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgaW5mbyA9IHtcbiAgICAgICAgICAgICAgICBwYXRoOiB0aGlzLmRiUGF0aCxcbiAgICAgICAgICAgICAgICBzaXplOiByZXF1aXJlKCdmcycpLnN0YXRTeW5jKHRoaXMuZGJQYXRoKS5zaXplLFxuICAgICAgICAgICAgICAgIHRhYmxlczogW10sXG4gICAgICAgICAgICAgICAgdmVyc2lvbjogdGhpcy5kYi5wcmFnbWEoJ3VzZXJfdmVyc2lvbicpWzBdLnVzZXJfdmVyc2lvblxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy8gR2V0IHRhYmxlIG5hbWVzIHbDoCByb3cgY291bnRzXG4gICAgICAgICAgICBjb25zdCB0YWJsZXMgPSB0aGlzLmRiLnByZXBhcmUoYFxuICAgICAgICAgICAgICAgIFNFTEVDVCBuYW1lIEZST00gc3FsaXRlX21hc3RlciBcbiAgICAgICAgICAgICAgICBXSEVSRSB0eXBlPSd0YWJsZScgQU5EIG5hbWUgTk9UIExJS0UgJ3NxbGl0ZV8lJ1xuICAgICAgICAgICAgYCkuYWxsKCk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgdGFibGUgb2YgdGFibGVzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY291bnQgPSB0aGlzLmRiLnByZXBhcmUoYFNFTEVDVCBDT1VOVCgqKSBhcyBjb3VudCBGUk9NICR7dGFibGUubmFtZX1gKS5nZXQoKTtcbiAgICAgICAgICAgICAgICBpbmZvLnRhYmxlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogdGFibGUubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgcm93czogY291bnQuY291bnRcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGluZm87XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBlcnJvcignRXJyb3IgZ2V0dGluZyBkYXRhYmFzZSBpbmZvOicsIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogS2nhu4NtIHRyYSB2w6Agc+G7rWEgY2jhu69hIGLhuqNuZyByb29tcyBu4bq/dSBjw7MgbOG7l2kgc2NoZW1hXG4gICAgICovXG4gICAgYXN5bmMgZml4Um9vbXNUYWJsZSgpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxvZygn8J+UpyBLaeG7g20gdHJhIGPhuqV1IHRyw7pjIGLhuqNuZyByb29tcy4uLicpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBM4bqleSB0aMO0bmcgdGluIHbhu4EgYuG6o25nIHJvb21zXG4gICAgICAgICAgICBjb25zdCB0YWJsZUluZm8gPSB0aGlzLmRiLnByZXBhcmUoYFNFTEVDVCBzcWwgRlJPTSBzcWxpdGVfbWFzdGVyIFdIRVJFIHR5cGUgPSAndGFibGUnIEFORCBuYW1lID0gJ3Jvb21zJ2ApLmdldCgpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBLaeG7g20gdHJhIHhlbSBi4bqjbmcgY8OzIGPhu5l0IHVzZXJuYW1lIGLhuq90IGJ14buZYyBraMO0bmcgdOG7k24gdOG6oWkgdHJvbmcgc2NoZW1hXG4gICAgICAgICAgICBpZiAodGFibGVJbmZvICYmIHRhYmxlSW5mby5zcWwgJiYgdGFibGVJbmZvLnNxbC5pbmNsdWRlcygndXNlcm5hbWUgVEVYVCBOT1QgTlVMTCcpKSB7XG4gICAgICAgICAgICAgICAgbG9nKCfinYwgUGjDoXQgaGnhu4duIHNjaGVtYSBs4buXaTogY+G7mXQgdXNlcm5hbWUgTk9UIE5VTEwgdHJvbmcgYuG6o25nIHJvb21zJyk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gTMawdSBk4buvIGxp4buHdSBoaeG7h24gdOG6oWlcbiAgICAgICAgICAgICAgICBsb2coJ+KPsyBTYW8gbMawdSBk4buvIGxp4buHdSBoaeG7h24gdOG6oWkuLi4nKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRiLmV4ZWMoYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHJvb21zX2JhY2t1cCBBUyBTRUxFQ1QgKiBGUk9NIHJvb21zYCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gWMOzYSBpbmRleCBjxalcbiAgICAgICAgICAgICAgICBsb2coJ+KPsyBYw7NhIGluZGV4IGPFqS4uLicpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGIuZXhlYyhgRFJPUCBJTkRFWCBJRiBFWElTVFMgaWR4X3Jvb21zX3VzZXJuYW1lYCk7XG4gICAgICAgICAgICAgICAgdGhpcy5kYi5leGVjKGBEUk9QIElOREVYIElGIEVYSVNUUyBpZHhfcm9vbXNfbGl2ZWApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFjDs2EgYuG6o25nIGPFqVxuICAgICAgICAgICAgICAgIGxvZygn4o+zIFjDs2EgYuG6o25nIGPFqSDEkeG7gyB04bqhbyBs4bqhaS4uLicpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGIuZXhlYyhgRFJPUCBUQUJMRSByb29tc2ApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFThuqFvIGzhuqFpIGLhuqNuZyB24bubaSBzY2hlbWEgxJHDum5nXG4gICAgICAgICAgICAgICAgbG9nKCfij7MgVOG6oW8gbOG6oWkgYuG6o25nIHbhu5tpIHNjaGVtYSBjaMOtbmggeMOhYy4uLicpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGIuZXhlYyhgXG4gICAgICAgICAgICAgICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHJvb21zIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHVpZCBURVhUIFBSSU1BUlkgS0VZLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWQgVEVYVCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvb21JZCBURVhULFxuICAgICAgICAgICAgICAgICAgICAgICAgcm9vbVVybCBURVhULFxuICAgICAgICAgICAgICAgICAgICAgICAgcm9vbVVzZXJuYW1lIFRFWFQsXG4gICAgICAgICAgICAgICAgICAgICAgICBuaWNrbmFtZSBURVhULFxuICAgICAgICAgICAgICAgICAgICAgICAgYXZhdGFyIFRFWFQsXG4gICAgICAgICAgICAgICAgICAgICAgICBhdmF0YXJUaHVtYiBURVhULFxuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGUgVEVYVCBERUZBVUxUICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmlld2VyQ291bnQgSU5URUdFUiBERUZBVUxUIDAsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Vmlld2VycyBJTlRFR0VSIERFRkFVTFQgMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0Q291bnQgSU5URUdFUiBERUZBVUxUIDAsXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRWaWV3ZXJzIElOVEVHRVIgREVGQVVMVCAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb24gSU5URUdFUiBERUZBVUxUIDMwLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNMaXZlIElOVEVHRVIgREVGQVVMVCAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFZpZXdlZCBURVhULFxuICAgICAgICAgICAgICAgICAgICAgICAgbm90ZXMgVEVYVCBERUZBVUxUICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzIFRFWFQgREVGQVVMVCAnc3RvcHBlZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydGVkQXQgVEVYVCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZGVkQXQgVEVYVCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWxWaWV3ZXJzIElOVEVHRVIgREVGQVVMVCAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFRpbWVDaGVja1ZpZXdlcnMgVEVYVCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BwZWRBdCBURVhULFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFJlYXNvbiBURVhULFxuICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxEdXJhdGlvbiBJTlRFR0VSIERFRkFVTFQgMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZWRBdCBURVhUIE5PVCBOVUxMLFxuICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZEF0IFRFWFQgTk9UIE5VTExcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIGApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFThuqFvIGzhuqFpIGluZGV4XG4gICAgICAgICAgICAgICAgbG9nKCfij7MgVOG6oW8gbOG6oWkgaW5kZXguLi4nKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRiLmV4ZWMoYENSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF9yb29tc19yb29tVXNlcm5hbWUgT04gcm9vbXMocm9vbVVzZXJuYW1lKWApO1xuICAgICAgICAgICAgICAgIHRoaXMuZGIuZXhlYyhgQ1JFQVRFIElOREVYIElGIE5PVCBFWElTVFMgaWR4X3Jvb21zX2xpdmUgT04gcm9vbXMoaXNMaXZlKWApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEtow7RpIHBo4bulYyBk4buvIGxp4buHdSAtIHNhbyBjaMOpcCB04burIHVzZXJuYW1lIHNhbmcgcm9vbVVzZXJuYW1lXG4gICAgICAgICAgICAgICAgbG9nKCfij7MgS2jDtGkgcGjhu6VjIGThu68gbGnhu4d1IHThu6sgYuG6o25nIGJhY2t1cC4uLicpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGIuZXhlYyhgXG4gICAgICAgICAgICAgICAgICAgIElOU0VSVCBJTlRPIHJvb21zIFxuICAgICAgICAgICAgICAgICAgICBTRUxFQ1QgXG4gICAgICAgICAgICAgICAgICAgICAgICB1aWQsIGlkLCByb29tSWQsIHJvb21VcmwsIFxuICAgICAgICAgICAgICAgICAgICAgICAgQ09BTEVTQ0Uocm9vbVVzZXJuYW1lLCB1c2VybmFtZSkgYXMgcm9vbVVzZXJuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmlja25hbWUsIGF2YXRhciwgYXZhdGFyVGh1bWIsIHRpdGxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmlld2VyQ291bnQsIGN1cnJlbnRWaWV3ZXJzLCBzdGFydENvdW50LCB0YXJnZXRWaWV3ZXJzLCBcbiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uLCBpc0xpdmUsIGxhc3RWaWV3ZWQsIG5vdGVzLCBcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cywgc3RhcnRlZEF0LCBlbmRlZEF0LCByZWFsVmlld2VycywgXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0VGltZUNoZWNrVmlld2Vycywgc3RvcHBlZEF0LCBzdG9wUmVhc29uLCBmaW5hbER1cmF0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlZEF0LCB1cGRhdGVkQXQgXG4gICAgICAgICAgICAgICAgICAgIEZST00gcm9vbXNfYmFja3VwXG4gICAgICAgICAgICAgICAgYCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gWMOzYSBi4bqjbmcgYmFja3VwXG4gICAgICAgICAgICAgICAgbG9nKCfij7MgWMOzYSBi4bqjbmcgYmFja3VwLi4uJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5kYi5leGVjKGBEUk9QIFRBQkxFIHJvb21zX2JhY2t1cGApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxvZygn4pyFIMSQw6Mgc+G7rWEgY2jhu69hIGLhuqNuZyByb29tcyB0aMOgbmggY8O0bmchJyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxvZygn4pyFIEPhuqV1IHRyw7pjIGLhuqNuZyByb29tcyBPSycpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBlcnJvcign4p2MIEVycm9yIGZpeGluZyByb29tcyB0YWJsZTonLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRGF0YWJhc2VTY2hlbWE7ICIsImNvbnN0IEJhc2VTdG9yYWdlID0gcmVxdWlyZSgnLi9iYXNlLXN0b3JhZ2UnKTtcbmNvbnN0IHsgcmFuZG9tVVVJRCB9ID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5jb25zdCB7IGxvZywgZXJyb3IgfSA9IHJlcXVpcmUoJy4uL2xvZ2dlcicpO1xuXG5jbGFzcyBGb2xkZXJTdG9yYWdlIGV4dGVuZHMgQmFzZVN0b3JhZ2Uge1xuICAgIC8qKlxuICAgICAqIEzhuqV5IHThuqV0IGPhuqMgZm9sZGVycyB0aGVvIHR5cGVcbiAgICAgKi9cbiAgICBhc3luYyBnZXRBbGxGb2xkZXJzKHR5cGUgPSAnYWNjb3VudHMnKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsb2coYPCflI0gR2V0dGluZyBhbGwgZm9sZGVycyBmb3IgdHlwZTogJHt0eXBlfWApO1xuICAgICAgICAgICAgY29uc3Qgc3RtdCA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICAgICAgICAgICAgU0VMRUNUICogRlJPTSBmb2xkZXJzIFxuICAgICAgICAgICAgICAgIFdIRVJFIHR5cGUgPSA/IFxuICAgICAgICAgICAgICAgIE9SREVSIEJZIG5hbWUgQVNDXG4gICAgICAgICAgICBgKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgZm9sZGVycyA9IHN0bXQuYWxsKHR5cGUpLm1hcChmb2xkZXIgPT4gKHtcbiAgICAgICAgICAgICAgICAuLi5mb2xkZXIsXG4gICAgICAgICAgICAgICAgLy8gS2VlcCBhcyBJU08gc3RyaW5ncyBmb3IgSVBDIGNvbXBhdGliaWxpdHlcbiAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IGZvbGRlci5jcmVhdGVkQXQsXG4gICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBmb2xkZXIudXBkYXRlZEF0XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxvZyhg4pyFIEZvdW5kICR7Zm9sZGVycy5sZW5ndGh9IGZvbGRlcnMgZm9yIHR5cGUgJHt0eXBlfWApO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplRm9ySVBDKGZvbGRlcnMpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGVycm9yKCfinYwgRXJyb3IgZ2V0dGluZyBhbGwgZm9sZGVyczonLCBlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVOG6oW8gZm9sZGVyIG3hu5tpXG4gICAgICovXG4gICAgYXN5bmMgY3JlYXRlRm9sZGVyKHR5cGUsIGZvbGRlckRhdGEpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxvZyhg8J+UpyBDcmVhdGluZyBuZXcgZm9sZGVyOiAke2ZvbGRlckRhdGEubmFtZX0gKHR5cGU6ICR7dHlwZX0pYCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEtp4buDbSB0cmEgZm9sZGVyIMSRw6MgdOG7k24gdOG6oWkgY2jGsGFcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nRm9sZGVyID0gYXdhaXQgdGhpcy5nZXRGb2xkZXJCeU5hbWUodHlwZSwgZm9sZGVyRGF0YS5uYW1lKTtcbiAgICAgICAgICAgIGlmIChleGlzdGluZ0ZvbGRlcikge1xuICAgICAgICAgICAgICAgIGxvZyhg4pqg77iPIEZvbGRlciBhbHJlYWR5IGV4aXN0czogJHtmb2xkZXJEYXRhLm5hbWV9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiBgRm9sZGVyICcke2ZvbGRlckRhdGEubmFtZX0nIMSRw6MgdOG7k24gdOG6oWkgdHJvbmcgJHt0eXBlfWBcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBpZCA9IHJhbmRvbVVVSUQoKTtcbiAgICAgICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3Qgc3RtdCA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICAgICAgICAgICAgSU5TRVJUIElOVE8gZm9sZGVycyAoXG4gICAgICAgICAgICAgICAgICAgIGlkLCBuYW1lLCB0eXBlLCBjb2xvciwgZGVzY3JpcHRpb24sXG4gICAgICAgICAgICAgICAgICAgIGNyZWF0ZWRBdCwgdXBkYXRlZEF0XG4gICAgICAgICAgICAgICAgKSBWQUxVRVMgKD8sID8sID8sID8sID8sID8sID8pXG4gICAgICAgICAgICBgKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgc3RtdC5ydW4oXG4gICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgZm9sZGVyRGF0YS5uYW1lLFxuICAgICAgICAgICAgICAgIHR5cGUsXG4gICAgICAgICAgICAgICAgZm9sZGVyRGF0YS5jb2xvciB8fCAnIzAwN2JmZicsXG4gICAgICAgICAgICAgICAgZm9sZGVyRGF0YS5kZXNjcmlwdGlvbiB8fCAnJyxcbiAgICAgICAgICAgICAgICBub3csXG4gICAgICAgICAgICAgICAgbm93XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBuZXdGb2xkZXIgPSB7XG4gICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgbmFtZTogZm9sZGVyRGF0YS5uYW1lLFxuICAgICAgICAgICAgICAgIHR5cGUsXG4gICAgICAgICAgICAgICAgY29sb3I6IGZvbGRlckRhdGEuY29sb3IgfHwgJyMwMDdiZmYnLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBmb2xkZXJEYXRhLmRlc2NyaXB0aW9uIHx8ICcnLFxuICAgICAgICAgICAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgICAgICAgICAgIHVwZGF0ZWRBdDogbm93XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsb2coYOKchSBDcmVhdGVkIG5ldyBmb2xkZXI6ICR7Zm9sZGVyRGF0YS5uYW1lfSAoaWQ6ICR7aWR9KWApO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGRhdGE6IG5ld0ZvbGRlclxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBlcnJvcign4p2MIEVycm9yIGNyZWF0aW5nIGZvbGRlcjonLCBlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2VcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBD4bqtcCBuaOG6rXQgZm9sZGVyXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlRm9sZGVyKHR5cGUsIGZvbGRlcklkLCB1cGRhdGVzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHNldEZpZWxkcyA9IFtdO1xuICAgICAgICAgICAgY29uc3QgdmFsdWVzID0gW107XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHVwZGF0ZXMpKSB7XG4gICAgICAgICAgICAgICAgc2V0RmllbGRzLnB1c2goYCR7a2V5fSA9ID9gKTtcbiAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChzZXRGaWVsZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBzZXRGaWVsZHMucHVzaCgndXBkYXRlZEF0ID0gPycpO1xuICAgICAgICAgICAgdmFsdWVzLnB1c2gobm93KTtcbiAgICAgICAgICAgIHZhbHVlcy5wdXNoKGZvbGRlcklkKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3Qgc3FsID0gYFVQREFURSBmb2xkZXJzIFNFVCAke3NldEZpZWxkcy5qb2luKCcsICcpfSBXSEVSRSBpZCA9ID8gQU5EIHR5cGUgPSA/YDtcbiAgICAgICAgICAgIHZhbHVlcy5wdXNoKHR5cGUpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKHNxbCk7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBzdG10LnJ1biguLi52YWx1ZXMpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAocmVzdWx0LmNoYW5nZXMgPiAwKSB7XG4gICAgICAgICAgICAgICAgbG9nKGDinIUgVXBkYXRlZCAke3R5cGV9IGZvbGRlciAke2ZvbGRlcklkfWApO1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnRm9sZGVyIG5vdCBmb3VuZCcgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGVycm9yKCdFcnJvciB1cGRhdGluZyBmb2xkZXI6JywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBYw7NhIGZvbGRlclxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZUZvbGRlcih0eXBlLCBmb2xkZXJJZCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gS2nhu4NtIHRyYSB4ZW0gZm9sZGVyIGPDsyBpdGVtcyBraMO0bmdcbiAgICAgICAgICAgIGNvbnN0IGNoZWNrVGFibGUgPSB0eXBlID09PSAnYWNjb3VudHMnID8gJ2FjY291bnRzJyA6ICdwcm94aWVzJztcbiAgICAgICAgICAgIGNvbnN0IGNoZWNrU3RtdCA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICAgICAgICAgICAgU0VMRUNUIENPVU5UKCopIGFzIGNvdW50IEZST00gJHtjaGVja1RhYmxlfSBXSEVSRSBmb2xkZXJJZCA9ID9cbiAgICAgICAgICAgIGApO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2hlY2tTdG10LmdldChmb2xkZXJJZCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChyZXN1bHQuY291bnQgPiAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLCBcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGBDYW5ub3QgZGVsZXRlIGZvbGRlci4gSXQgY29udGFpbnMgJHtyZXN1bHQuY291bnR9IGl0ZW1zLmAgXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gWMOzYSBmb2xkZXJcbiAgICAgICAgICAgIGNvbnN0IGRlbGV0ZVN0bXQgPSB0aGlzLmRiLnByZXBhcmUoYFxuICAgICAgICAgICAgICAgIERFTEVURSBGUk9NIGZvbGRlcnMgV0hFUkUgaWQgPSA/IEFORCB0eXBlID0gP1xuICAgICAgICAgICAgYCk7XG4gICAgICAgICAgICBjb25zdCBkZWxldGVSZXN1bHQgPSBkZWxldGVTdG10LnJ1bihmb2xkZXJJZCwgdHlwZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChkZWxldGVSZXN1bHQuY2hhbmdlcyA+IDApIHtcbiAgICAgICAgICAgICAgICBsb2coYOKchSBEZWxldGVkICR7dHlwZX0gZm9sZGVyICR7Zm9sZGVySWR9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdGb2xkZXIgbm90IGZvdW5kJyB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGVycm9yKCdFcnJvciBkZWxldGluZyBmb2xkZXI6JywgZXJyKTtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogZXJyLm1lc3NhZ2UgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBmb2xkZXIgYnkgSURcbiAgICAgKi9cbiAgICBhc3luYyBnZXRGb2xkZXJCeUlkKHR5cGUsIGZvbGRlcklkKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKGBcbiAgICAgICAgICAgICAgICBTRUxFQ1QgKiBGUk9NIGZvbGRlcnMgV0hFUkUgaWQgPSA/IEFORCB0eXBlID0gP1xuICAgICAgICAgICAgYCk7XG4gICAgICAgICAgICBjb25zdCBmb2xkZXIgPSBzdG10LmdldChmb2xkZXJJZCwgdHlwZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBmb2xkZXIgPyB0aGlzLnNlcmlhbGl6ZUZvcklQQyhmb2xkZXIpIDogbnVsbDtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGVycm9yKCdFcnJvciBnZXR0aW5nIGZvbGRlciBieSBJRDonLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEzhuqV5IGZvbGRlciB0aGVvIHTDqm5cbiAgICAgKi9cbiAgICBhc3luYyBnZXRGb2xkZXJCeU5hbWUodHlwZSwgbmFtZSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbG9nKGDwn5SOIExvb2tpbmcgZm9yIGZvbGRlciB3aXRoIG5hbWU6IFwiJHtuYW1lfVwiIGFuZCB0eXBlOiBcIiR7dHlwZX1cImApO1xuICAgICAgICAgICAgY29uc3Qgc3RtdCA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICAgICAgICAgICAgU0VMRUNUICogRlJPTSBmb2xkZXJzIFxuICAgICAgICAgICAgICAgIFdIRVJFIHR5cGUgPSA/IEFORCBuYW1lID0gP1xuICAgICAgICAgICAgYCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHN0bXQuZ2V0KHR5cGUsIG5hbWUpO1xuICAgICAgICAgICAgbG9nKGDwn5SNIEZvbGRlciBsb29rdXAgcmVzdWx0OiAke3Jlc3VsdCA/IGBGb3VuZCBmb2xkZXIgd2l0aCBJRCAke3Jlc3VsdC5pZH1gIDogJ05vIGZvbGRlciBmb3VuZCd9YCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgZXJyb3IoJ+KdjCBFcnJvciBnZXR0aW5nIGZvbGRlciBieSBuYW1lOicsIGVycik7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBGb2xkZXJTdG9yYWdlOyAiLCJjb25zdCBCYXNlU3RvcmFnZSA9IHJlcXVpcmUoJy4vYmFzZS1zdG9yYWdlJyk7XG5jb25zdCB7IGxvZywgZXJyb3IgfSA9IHJlcXVpcmUoJy4uLy4uL2xpYi9sb2dnZXInKTtcbmNsYXNzIFByb3h5U3RvcmFnZSBleHRlbmRzIEJhc2VTdG9yYWdlIHtcbiAgICAvKipcbiAgICAgKiBM4bqleSB04bqldCBj4bqjIHByb3hpZXNcbiAgICAgKi9cbiAgICBhc3luYyBnZXRBbGxQcm94aWVzKCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3Qgc3RtdCA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICAgICAgICAgICAgU0VMRUNUIHAuKiwgZi5uYW1lIGFzIGZvbGRlck5hbWUsIGYuY29sb3IgYXMgZm9sZGVyQ29sb3JcbiAgICAgICAgICAgICAgICBGUk9NIHByb3hpZXMgcFxuICAgICAgICAgICAgICAgIExFRlQgSk9JTiBmb2xkZXJzIGYgT04gcC5mb2xkZXJJZCA9IGYuaWRcbiAgICAgICAgICAgICAgICBPUkRFUiBCWSBwLmhvc3QgQVNDXG4gICAgICAgICAgICBgKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcHJveGllcyA9IHN0bXQuYWxsKCkubWFwKHByb3h5ID0+ICh7XG4gICAgICAgICAgICAgICAgLi4ucHJveHksXG4gICAgICAgICAgICAgICAgcG9ydDogcGFyc2VJbnQocHJveHkucG9ydCksIC8vIEVuc3VyZSBwb3J0IGlzIGludGVnZXIgZm9yIElQQ1xuICAgICAgICAgICAgICAgIGxhc3RUZXN0ZWQ6IHByb3h5Lmxhc3RUZXN0ZWQsXG4gICAgICAgICAgICAgICAgY3JlYXRlZEF0OiBwcm94eS5jcmVhdGVkQXQsXG4gICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBwcm94eS51cGRhdGVkQXRcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplRm9ySVBDKHByb3hpZXMpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXJyb3IoJ0Vycm9yIGdldHRpbmcgYWxsIHByb3hpZXM6JywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTOG6pXkgcHJveGllcyB0aGVvIGZvbGRlclxuICAgICAqL1xuICAgIGFzeW5jIGdldFByb3hpZXNCeUZvbGRlcihmb2xkZXJJZCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3Qgc3RtdCA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICAgICAgICAgICAgU0VMRUNUIHAuKiwgZi5uYW1lIGFzIGZvbGRlck5hbWUsIGYuY29sb3IgYXMgZm9sZGVyQ29sb3JcbiAgICAgICAgICAgICAgICBGUk9NIHByb3hpZXMgcFxuICAgICAgICAgICAgICAgIExFRlQgSk9JTiBmb2xkZXJzIGYgT04gcC5mb2xkZXJJZCA9IGYuaWRcbiAgICAgICAgICAgICAgICBXSEVSRSBwLmZvbGRlcklkID0gP1xuICAgICAgICAgICAgICAgIE9SREVSIEJZIHAuaG9zdCBBU0NcbiAgICAgICAgICAgIGApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBwcm94aWVzID0gc3RtdC5hbGwoZm9sZGVySWQpLm1hcChwcm94eSA9PiAoe1xuICAgICAgICAgICAgICAgIC4uLnByb3h5LFxuICAgICAgICAgICAgICAgIHBvcnQ6IHBhcnNlSW50KHByb3h5LnBvcnQpLFxuICAgICAgICAgICAgICAgIGxhc3RUZXN0ZWQ6IHByb3h5Lmxhc3RUZXN0ZWQsXG4gICAgICAgICAgICAgICAgY3JlYXRlZEF0OiBwcm94eS5jcmVhdGVkQXQsXG4gICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBwcm94eS51cGRhdGVkQXRcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplRm9ySVBDKHByb3hpZXMpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXJyb3IoJ0Vycm9yIGdldHRpbmcgcHJveGllcyBieSBmb2xkZXI6JywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGjDqm0gcHJveHkgbeG7m2lcbiAgICAgKi9cbiAgICBhc3luYyBhZGRQcm94eShwcm94eURhdGEpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIFThuqFvIElEIG3hu5tpIG7hur91IGNoxrBhIGPDs1xuICAgICAgICAgICAgY29uc3QgcHJveHlJZCA9IHByb3h5RGF0YS5pZCB8fCB0aGlzLmdlbmVyYXRlSWQoKTtcbiAgICAgICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gSG9zdCBsw6AgYuG6r3QgYnXhu5ljXG4gICAgICAgICAgICBpZiAoIXByb3h5RGF0YS5ob3N0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLCBcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICdIb3N0IGlzIHJlcXVpcmVkIGZvciBwcm94eScgXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gVmFsaWRhdGUgcG9ydFxuICAgICAgICAgICAgY29uc3QgcG9ydCA9IHBhcnNlSW50KHByb3h5RGF0YS5wb3J0KSB8fCA4MDgwO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBLaeG7g20gdHJhIHhlbSBwcm94eSDEkcOjIHThu5NuIHThuqFpIGNoxrBhXG4gICAgICAgICAgICBjb25zdCBleGlzdGluZ1Byb3h5ID0gdGhpcy5kYi5wcmVwYXJlKGBcbiAgICAgICAgICAgICAgICBTRUxFQ1QgaWQgRlJPTSBwcm94aWVzIFdIRVJFIGhvc3QgPSA/IEFORCBwb3J0ID0gP1xuICAgICAgICAgICAgYCkuZ2V0KHByb3h5RGF0YS5ob3N0LCBwb3J0KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGV4aXN0aW5nUHJveHkpIHtcbiAgICAgICAgICAgICAgICBsb2coYOKaoO+4jyBQcm94eSAke3Byb3h5RGF0YS5ob3N0fToke3BvcnR9IMSRw6MgdOG7k24gdOG6oWksIHPhur0gY+G6rXAgbmjhuq10YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlUHJveHkoZXhpc3RpbmdQcm94eS5pZCwge1xuICAgICAgICAgICAgICAgICAgICAuLi5wcm94eURhdGEsXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRBdDogbm93XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxvZyhg8J+TnSBBZGRpbmcgcHJveHk6ICR7cHJveHlEYXRhLmhvc3R9OiR7cG9ydH1gKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gVGjDqm0gcHJveHkgbeG7m2lcbiAgICAgICAgICAgIGNvbnN0IHN0bXQgPSB0aGlzLmRiLnByZXBhcmUoYFxuICAgICAgICAgICAgICAgIElOU0VSVCBJTlRPIHByb3hpZXMgKFxuICAgICAgICAgICAgICAgICAgICBpZCwgaG9zdCwgcG9ydCwgdXNlcm5hbWUsIHBhc3N3b3JkLCBcbiAgICAgICAgICAgICAgICAgICAgdHlwZSwgZm9sZGVySWQsIHN0YXR1cywgbGFzdFRlc3RlZCwgXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlVGltZSwgbm90ZXMsIGNyZWF0ZWRBdCwgdXBkYXRlZEF0XG4gICAgICAgICAgICAgICAgKSBWQUxVRVMgKD8sID8sID8sID8sID8sID8sID8sID8sID8sID8sID8sID8sID8pXG4gICAgICAgICAgICBgKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgc3RtdC5ydW4oXG4gICAgICAgICAgICAgICAgcHJveHlJZCxcbiAgICAgICAgICAgICAgICBwcm94eURhdGEuaG9zdCxcbiAgICAgICAgICAgICAgICBwb3J0LFxuICAgICAgICAgICAgICAgIHByb3h5RGF0YS51c2VybmFtZSB8fCBudWxsLFxuICAgICAgICAgICAgICAgIHByb3h5RGF0YS5wYXNzd29yZCB8fCBudWxsLFxuICAgICAgICAgICAgICAgIHByb3h5RGF0YS50eXBlIHx8ICdodHRwJyxcbiAgICAgICAgICAgICAgICBwcm94eURhdGEuZm9sZGVySWQgfHwgbnVsbCxcbiAgICAgICAgICAgICAgICBwcm94eURhdGEuc3RhdHVzIHx8ICdhY3RpdmUnLCAvLyBN4bq3YyDEkeG7i25oIGzDoCBhY3RpdmVcbiAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgIDAsXG4gICAgICAgICAgICAgICAgcHJveHlEYXRhLm5vdGVzIHx8ICcnLFxuICAgICAgICAgICAgICAgIG5vdyxcbiAgICAgICAgICAgICAgICBub3dcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IG5ld1Byb3h5ID0ge1xuICAgICAgICAgICAgICAgIGlkOiBwcm94eUlkLFxuICAgICAgICAgICAgICAgIGhvc3Q6IHByb3h5RGF0YS5ob3N0LFxuICAgICAgICAgICAgICAgIHBvcnQ6IHBvcnQsXG4gICAgICAgICAgICAgICAgdXNlcm5hbWU6IHByb3h5RGF0YS51c2VybmFtZSB8fCBudWxsLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwcm94eURhdGEucGFzc3dvcmQgfHwgbnVsbCxcbiAgICAgICAgICAgICAgICB0eXBlOiBwcm94eURhdGEudHlwZSB8fCAnaHR0cCcsXG4gICAgICAgICAgICAgICAgZm9sZGVySWQ6IHByb3h5RGF0YS5mb2xkZXJJZCB8fCBudWxsLFxuICAgICAgICAgICAgICAgIHN0YXR1czogcHJveHlEYXRhLnN0YXR1cyB8fCAnYWN0aXZlJywgLy8gTeG6t2MgxJHhu4tuaCBsw6AgYWN0aXZlXG4gICAgICAgICAgICAgICAgbGFzdFRlc3RlZDogbnVsbCxcbiAgICAgICAgICAgICAgICByZXNwb25zZVRpbWU6IDAsXG4gICAgICAgICAgICAgICAgbm90ZXM6IHByb3h5RGF0YS5ub3RlcyB8fCAnJyxcbiAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICAgICAgICAgICAgICB1cGRhdGVkQXQ6IG5vd1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbG9nKGDinIUgQWRkZWQgcHJveHk6ICR7cHJveHlEYXRhLmhvc3R9OiR7cG9ydH1gKTtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHByb3h5OiB0aGlzLnNlcmlhbGl6ZUZvcklQQyhuZXdQcm94eSkgfTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGVycm9yKCdFcnJvciBhZGRpbmcgcHJveHk6JywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBYw7NhIHByb3h5XG4gICAgICovXG4gICAgYXN5bmMgZGVsZXRlUHJveHkocHJveHlJZCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gVXBkYXRlIGFjY291bnRzIHVzaW5nIHRoaXMgcHJveHlcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUFjY291bnRzU3RtdCA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICAgICAgICAgICAgVVBEQVRFIGFjY291bnRzIFNFVCBwcm94eUlkID0gTlVMTCBXSEVSRSBwcm94eUlkID0gP1xuICAgICAgICAgICAgYCk7XG4gICAgICAgICAgICB1cGRhdGVBY2NvdW50c1N0bXQucnVuKHByb3h5SWQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBEZWxldGUgcHJveHlcbiAgICAgICAgICAgIGNvbnN0IHN0bXQgPSB0aGlzLmRiLnByZXBhcmUoYERFTEVURSBGUk9NIHByb3hpZXMgV0hFUkUgaWQgPSA/YCk7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBzdG10LnJ1bihwcm94eUlkKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VzID4gMCkge1xuICAgICAgICAgICAgICAgIGxvZyhg4pyFIERlbGV0ZWQgcHJveHkgJHtwcm94eUlkfWApO1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnUHJveHkgbm90IGZvdW5kJyB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXJyb3IoJ0Vycm9yIGRlbGV0aW5nIHByb3h5OicsIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ+G6rXAgbmjhuq10IHByb3h5XG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlUHJveHkoaWQsIHVwZGF0ZXMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3Qgc2V0RmllbGRzID0gW107XG4gICAgICAgICAgICBjb25zdCB2YWx1ZXMgPSBbXTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModXBkYXRlcykpIHtcbiAgICAgICAgICAgICAgICAvLyBT4butYSBs4buXaSBsYXN0VXBkYXRlZCAtPiB1cGRhdGVkQXRcbiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnbGFzdFVwZGF0ZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZygn4pqg77iPIEPhu5l0IGxhc3RVcGRhdGVkIMSRxrDhu6NjIHRoYXkgxJHhu5VpIHRow6BuaCB1cGRhdGVkQXQnKTtcbiAgICAgICAgICAgICAgICAgICAgc2V0RmllbGRzLnB1c2goYHVwZGF0ZWRBdCA9ID9gKTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ21ldGFkYXRhJykge1xuICAgICAgICAgICAgICAgICAgICBzZXRGaWVsZHMucHVzaChgJHtrZXl9ID0gP2ApO1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaChKU09OLnN0cmluZ2lmeSh2YWx1ZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnbGFzdENoZWNrJykge1xuICAgICAgICAgICAgICAgICAgICBzZXRGaWVsZHMucHVzaChgJHtrZXl9ID0gP2ApO1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSA/IHZhbHVlIDogbnVsbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0RmllbGRzLnB1c2goYCR7a2V5fSA9ID9gKTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHNldEZpZWxkcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIENo4buJIHRow6ptIHVwZGF0ZWRBdCBu4bq/dSBraMO0bmcgxJHDoyBjw7MgdHJvbmcgdXBkYXRlc1xuICAgICAgICAgICAgaWYgKCF1cGRhdGVzLmhhc093blByb3BlcnR5KCd1cGRhdGVkQXQnKSAmJiAhdXBkYXRlcy5oYXNPd25Qcm9wZXJ0eSgnbGFzdFVwZGF0ZWQnKSkge1xuICAgICAgICAgICAgICAgIHNldEZpZWxkcy5wdXNoKCd1cGRhdGVkQXQgPSA/Jyk7XG4gICAgICAgICAgICAgICAgdmFsdWVzLnB1c2gobm93KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdmFsdWVzLnB1c2goaWQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBzcWwgPSBgVVBEQVRFIHByb3hpZXMgU0VUICR7c2V0RmllbGRzLmpvaW4oJywgJyl9IFdIRVJFIGlkID0gP2A7XG4gICAgICAgICAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKHNxbCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxvZyhg8J+UhCBVcGRhdGluZyBwcm94eSAke2lkfSB3aXRoIGZpZWxkczogJHtzZXRGaWVsZHMuam9pbignLCAnKX1gKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHN0bXQucnVuKC4uLnZhbHVlcyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChyZXN1bHQuY2hhbmdlcyA+IDApIHtcbiAgICAgICAgICAgICAgICBsb2coYOKchSBVcGRhdGVkIHByb3h5ICR7aWR9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdQcm94eSBub3QgZm91bmQnIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBlcnJvcignRXJyb3IgdXBkYXRpbmcgcHJveHk6JywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUZXN0IHByb3h5IGNvbm5lY3Rpb25cbiAgICAgKi9cbiAgICBhc3luYyB0ZXN0UHJveHkocHJveHlJZCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3Qgc3RtdCA9IHRoaXMuZGIucHJlcGFyZShgU0VMRUNUICogRlJPTSBwcm94aWVzIFdIRVJFIGlkID0gP2ApO1xuICAgICAgICAgICAgY29uc3QgcHJveHkgPSBzdG10LmdldChwcm94eUlkKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCFwcm94eSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ1Byb3h5IG5vdCBmb3VuZCcgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gVXBkYXRlIHN0YXR1cyB0byB0ZXN0aW5nXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZVByb3h5KHByb3h5SWQsIHsgc3RhdHVzOiAndGVzdGluZycgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgICAgICAgICBsZXQgc3RhdHVzID0gJ2Vycm9yJztcbiAgICAgICAgICAgIGxldCByZXNwb25zZVRpbWUgPSAwO1xuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vIFRlc3QgcHJveHkgYuG6sW5nIGF4aW9zIHbhu5tpIHRpbWVvdXRcbiAgICAgICAgICAgICAgICBjb25zdCBheGlvcyA9IHJlcXVpcmUoJ2F4aW9zJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgSHR0cHNQcm94eUFnZW50ID0gcmVxdWlyZSgnaHR0cHMtcHJveHktYWdlbnQnKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25zdCBwcm94eVVybCA9IHByb3h5LnVzZXJuYW1lICYmIHByb3h5LnBhc3N3b3JkIFxuICAgICAgICAgICAgICAgICAgICA/IGAke3Byb3h5LnR5cGV9Oi8vJHtwcm94eS51c2VybmFtZX06JHtwcm94eS5wYXNzd29yZH1AJHtwcm94eS5ob3N0fToke3Byb3h5LnBvcnR9YFxuICAgICAgICAgICAgICAgICAgICA6IGAke3Byb3h5LnR5cGV9Oi8vJHtwcm94eS5ob3N0fToke3Byb3h5LnBvcnR9YDtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGFnZW50ID0gbmV3IEh0dHBzUHJveHlBZ2VudChwcm94eVVybCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgYXdhaXQgYXhpb3MuZ2V0KCdodHRwczovL2h0dHBiaW4ub3JnL2lwJywge1xuICAgICAgICAgICAgICAgICAgICBodHRwc0FnZW50OiBhZ2VudCxcbiAgICAgICAgICAgICAgICAgICAgdGltZW91dDogMTAwMDBcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHJlc3BvbnNlVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICAgICAgICAgICAgc3RhdHVzID0gJ2FjdGl2ZSc7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGxvZyhgUHJveHkgdGVzdCBmYWlsZWQgZm9yICR7cHJveHkuaG9zdH06JHtwcm94eS5wb3J0fTpgLCBlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICByZXNwb25zZVRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgICAgICAgICAgIHN0YXR1cyA9ICdlcnJvcic7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFVwZGF0ZSBwcm94eSB3aXRoIHRlc3QgcmVzdWx0c1xuICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVQcm94eShwcm94eUlkLCB7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiBzdGF0dXMsXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VUaW1lOiByZXNwb25zZVRpbWUsXG4gICAgICAgICAgICAgICAgbGFzdFRlc3RlZDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbG9nKGDinIUgVGVzdGVkIHByb3h5ICR7cHJveHkuaG9zdH06JHtwcm94eS5wb3J0fSAtICR7c3RhdHVzfSAoJHtyZXNwb25zZVRpbWV9bXMpYCk7XG4gICAgICAgICAgICByZXR1cm4geyBcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLCBcbiAgICAgICAgICAgICAgICBzdGF0dXM6IHN0YXR1cywgXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VUaW1lOiByZXNwb25zZVRpbWUgXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBlcnJvcignRXJyb3IgdGVzdGluZyBwcm94eTonLCBlcnJvcik7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIFVwZGF0ZSBzdGF0dXMgdG8gZmFpbGVkIG9uIGVycm9yXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZVByb3h5KHByb3h5SWQsIHsgXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnZmFpbGVkJyxcbiAgICAgICAgICAgICAgICBsYXN0VGVzdGVkOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBwcm94eSBieSBJRFxuICAgICAqL1xuICAgIGFzeW5jIGdldFByb3h5QnlJZChwcm94eUlkKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKGBTRUxFQ1QgKiBGUk9NIHByb3hpZXMgV0hFUkUgaWQgPSA/YCk7XG4gICAgICAgICAgICBjb25zdCBwcm94eSA9IHN0bXQuZ2V0KHByb3h5SWQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoIXByb3h5KSB7XG4gICAgICAgICAgICAgICAgbG9nKGDimqDvuI8gUHJveHkgbm90IGZvdW5kIHdpdGggSUQ6ICR7cHJveHlJZH1gKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gRm9ybWF0IHByb3h5SW5mbyDEkeG7gyBk4buFIHPhu60gZOG7pW5nXG4gICAgICAgICAgICBsZXQgcHJveHlJbmZvO1xuICAgICAgICAgICAgaWYgKHByb3h5LnVzZXJuYW1lICYmIHByb3h5LnBhc3N3b3JkKSB7XG4gICAgICAgICAgICAgICAgcHJveHlJbmZvID0gYCR7cHJveHkudXNlcm5hbWV9OiR7cHJveHkucGFzc3dvcmR9QCR7cHJveHkuaG9zdH06JHtwcm94eS5wb3J0fWA7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb3h5SW5mbyA9IGAke3Byb3h5Lmhvc3R9OiR7cHJveHkucG9ydH1gO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGlkOiBwcm94eS5pZCxcbiAgICAgICAgICAgICAgICBob3N0OiBwcm94eS5ob3N0LFxuICAgICAgICAgICAgICAgIHBvcnQ6IHByb3h5LnBvcnQsXG4gICAgICAgICAgICAgICAgdXNlcm5hbWU6IHByb3h5LnVzZXJuYW1lLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwcm94eS5wYXNzd29yZCxcbiAgICAgICAgICAgICAgICB0eXBlOiBwcm94eS50eXBlLFxuICAgICAgICAgICAgICAgIHN0YXR1czogcHJveHkuc3RhdHVzLFxuICAgICAgICAgICAgICAgIGZvbGRlcklkOiBwcm94eS5mb2xkZXJJZCxcbiAgICAgICAgICAgICAgICBsYXN0VGVzdGVkOiBwcm94eS5sYXN0VGVzdGVkLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlVGltZTogcHJveHkucmVzcG9uc2VUaW1lLFxuICAgICAgICAgICAgICAgIG5vdGVzOiBwcm94eS5ub3RlcyxcbiAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IHByb3h5LmNyZWF0ZWRBdCxcbiAgICAgICAgICAgICAgICB1cGRhdGVkQXQ6IHByb3h5LnVwZGF0ZWRBdCxcbiAgICAgICAgICAgICAgICBwcm94eUluZm86IHByb3h5SW5mb1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGVycm9yKCdFcnJvciBnZXR0aW5nIHByb3h5IGJ5IElEOicsIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW1wb3J0IHByb3hpZXMgdOG7qyB0ZXh0ICht4buXaSBkw7JuZyBt4buZdCBwcm94eSlcbiAgICAgKi9cbiAgICBhc3luYyBpbXBvcnRQcm94aWVzRnJvbVRleHQodGV4dCwgZm9sZGVySWQgPSBudWxsKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsb2coYPCfk6UgSW1wb3J0aW5nIHByb3hpZXMgZnJvbSB0ZXh0LiBMZW5ndGg6ICR7dGV4dC5sZW5ndGh9LCBGb2xkZXJJZDogJHtmb2xkZXJJZCB8fCAnbnVsbCd9YCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIFjhu60gbMO9IGZvbGRlcklkIG7hur91IGzDoCAnZGVmYXVsdCcgaG/hurdjIG51bGxcbiAgICAgICAgICAgIGlmICghZm9sZGVySWQgfHwgZm9sZGVySWQgPT09ICdkZWZhdWx0Jykge1xuICAgICAgICAgICAgICAgIC8vIEtp4buDbSB0cmEgeGVtIGZvbGRlciAnZGVmYXVsdCcgY8OzIHThu5NuIHThuqFpIGtow7RuZ1xuICAgICAgICAgICAgICAgIGNvbnN0IGNoZWNrRm9sZGVyID0gdGhpcy5kYi5wcmVwYXJlKGBcbiAgICAgICAgICAgICAgICAgICAgU0VMRUNUIGlkIEZST00gZm9sZGVycyBXSEVSRSB0eXBlID0gJ3Byb3hpZXMnIEFORCAoaWQgPSAnZGVmYXVsdCcgT1IgbmFtZSA9ICdEZWZhdWx0JylcbiAgICAgICAgICAgICAgICBgKS5nZXQoKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIWNoZWNrRm9sZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZygn8J+TgSBDcmVhdGluZyBkZWZhdWx0IHByb3hpZXMgZm9sZGVyJyk7XG4gICAgICAgICAgICAgICAgICAgIC8vIFThuqFvIGZvbGRlciBt4bq3YyDEkeG7i25oIG7hur91IGNoxrBhIGPDs1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0Rm9sZGVySWQgPSAnZGVmYXVsdCc7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9sZGVyU3RtdCA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICAgICAgICAgICAgICAgICAgICBJTlNFUlQgSU5UTyBmb2xkZXJzIChpZCwgbmFtZSwgdHlwZSwgY29sb3IsIGRlc2NyaXB0aW9uLCBjcmVhdGVkQXQsIHVwZGF0ZWRBdClcbiAgICAgICAgICAgICAgICAgICAgICAgIFZBTFVFUyAoPywgPywgPywgPywgPywgPywgPylcbiAgICAgICAgICAgICAgICAgICAgYCk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBmb2xkZXJTdG10LnJ1bihcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRGb2xkZXJJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICdEZWZhdWx0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdwcm94aWVzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICcjM0I4MkY2JywgLy8gQmx1ZSBjb2xvclxuICAgICAgICAgICAgICAgICAgICAgICAgJ0RlZmF1bHQgZm9sZGVyIGZvciBwcm94aWVzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vdyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vd1xuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbG9nKCfinIUgQ3JlYXRlZCBkZWZhdWx0IHByb3hpZXMgZm9sZGVyJyk7XG4gICAgICAgICAgICAgICAgICAgIGZvbGRlcklkID0gZGVmYXVsdEZvbGRlcklkO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZvbGRlcklkID0gY2hlY2tGb2xkZXIuaWQ7XG4gICAgICAgICAgICAgICAgICAgIGxvZyhg8J+TgSBVc2luZyBleGlzdGluZyBkZWZhdWx0IGZvbGRlcjogJHtmb2xkZXJJZH1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIEtp4buDbSB0cmEgeGVtIGZvbGRlciDEkcOjIGNo4buNbiBjw7MgdOG7k24gdOG6oWkga2jDtG5nXG4gICAgICAgICAgICAgICAgY29uc3QgY2hlY2tGb2xkZXIgPSB0aGlzLmRiLnByZXBhcmUoYFxuICAgICAgICAgICAgICAgICAgICBTRUxFQ1QgaWQgRlJPTSBmb2xkZXJzIFdIRVJFIGlkID0gP1xuICAgICAgICAgICAgICAgIGApLmdldChmb2xkZXJJZCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFjaGVja0ZvbGRlcikge1xuICAgICAgICAgICAgICAgICAgICBlcnJvcihg4p2MIEZvbGRlciB3aXRoIElEICR7Zm9sZGVySWR9IGRvZXMgbm90IGV4aXN0YCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBgRm9sZGVyIHdpdGggSUQgJHtmb2xkZXJJZH0gZG9lcyBub3QgZXhpc3RgLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0czogW10sXG4gICAgICAgICAgICAgICAgICAgICAgICBpbXBvcnRlZDogMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiAwXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBUw6FjaCBjw6FjIGTDsm5nIHbDoCBs4buNYyBi4buPIGPDoWMgZMOybmcgdHLhu5FuZ1xuICAgICAgICAgICAgY29uc3QgbGluZXMgPSB0ZXh0LnNwbGl0KCdcXG4nKS5tYXAobGluZSA9PiBsaW5lLnRyaW0oKSkuZmlsdGVyKGxpbmUgPT4gbGluZS5sZW5ndGggPiAwKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBbXTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gUGFyc2UgdGjDtG5nIHRpbiBwcm94eSB04burIGTDsm5nIHRleHRcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJveHlEYXRhID0gdGhpcy5wYXJzZVByb3h5TGluZShsaW5lKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFThuqFvIHByb3h5IElEIHbDoCB0aMOqbSBmb2xkZXJJZFxuICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm94eUlkID0gdGhpcy5nZW5lcmF0ZUlkKCk7XG4gICAgICAgICAgICAgICAgICAgIHByb3h5RGF0YS5pZCA9IHByb3h5SWQ7XG4gICAgICAgICAgICAgICAgICAgIHByb3h5RGF0YS5mb2xkZXJJZCA9IGZvbGRlcklkO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gVGjDqm0gcHJveHkgdsOgbyBkYXRhYmFzZVxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmFkZFByb3h5KHByb3h5RGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJveHk6IGxpbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiByZXN1bHQuc3VjY2VzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiByZXN1bHQuc3VjY2VzcyA/IHByb3h5SWQgOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IHJlc3VsdC5lcnJvclxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBlcnJvcign4p2MIEVycm9yIHBhcnNpbmcgcHJveHkgbGluZTonLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm94eTogbGluZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2VcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBzdWNjZXNzQ291bnQgPSByZXN1bHRzLmZpbHRlcihyID0+IHIuc3VjY2VzcykubGVuZ3RoO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICAgICAgaW1wb3J0ZWQ6IHN1Y2Nlc3NDb3VudCxcbiAgICAgICAgICAgICAgICB0b3RhbDogbGluZXMubGVuZ3RoLFxuICAgICAgICAgICAgICAgIHJlc3VsdHM6IHJlc3VsdHNcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBlcnJvcign4p2MIEVycm9yIGltcG9ydGluZyBwcm94aWVzIGZyb20gdGV4dDonLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgICAgIGltcG9ydGVkOiAwLFxuICAgICAgICAgICAgICAgIHRvdGFsOiAwLFxuICAgICAgICAgICAgICAgIHJlc3VsdHM6IFtdXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFyc2UgcHJveHkgaW5mbyB04burIGxpbmUgdGV4dFxuICAgICAqL1xuICAgIHBhcnNlUHJveHlMaW5lKGxpbmUpIHtcbiAgICAgICAgbG9nKCfwn5SNIFBhcnNpbmcgcHJveHkgbGluZTonLCBsaW5lKTtcbiAgICAgICAgbGV0IGhvc3QgPSAnJywgcG9ydCA9IDAsIHVzZXJuYW1lID0gbnVsbCwgcGFzc3dvcmQgPSBudWxsLCB0eXBlID0gJ2h0dHAnO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBLaeG7g20gdHJhIMSR4buLbmggZOG6oW5nIHByb3h5XG4gICAgICAgICAgICBpZiAobGluZS5pbmNsdWRlcygnQCcpKSB7XG4gICAgICAgICAgICAgICAgLy8gxJDhu4tuaCBk4bqhbmcgdXNlcm5hbWU6cGFzc3dvcmRAaG9zdDpwb3J0XG4gICAgICAgICAgICAgICAgY29uc3QgW2F1dGgsIGhvc3RQb3J0XSA9IGxpbmUuc3BsaXQoJ0AnKTtcbiAgICAgICAgICAgICAgICBpZiAoYXV0aCAmJiBhdXRoLmluY2x1ZGVzKCc6JykpIHtcbiAgICAgICAgICAgICAgICAgICAgW3VzZXJuYW1lLCBwYXNzd29yZF0gPSBhdXRoLnNwbGl0KCc6Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChob3N0UG9ydCAmJiBob3N0UG9ydC5pbmNsdWRlcygnOicpKSB7XG4gICAgICAgICAgICAgICAgICAgIFtob3N0LCBwb3J0XSA9IGhvc3RQb3J0LnNwbGl0KCc6Jyk7XG4gICAgICAgICAgICAgICAgICAgIHBvcnQgPSBwYXJzZUludChwb3J0LCAxMCkgfHwgODA4MDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBob3N0ID0gaG9zdFBvcnQgfHwgJyc7XG4gICAgICAgICAgICAgICAgICAgIHBvcnQgPSA4MDgwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAobGluZS5pbmNsdWRlcygnOicpKSB7XG4gICAgICAgICAgICAgICAgLy8gxJDhu4tuaCBk4bqhbmcgaG9zdDpwb3J0IGhv4bq3YyBob3N0OnBvcnQ6dXNlcm5hbWU6cGFzc3dvcmRcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IGxpbmUuc3BsaXQoJzonKTtcbiAgICAgICAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID49IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgaG9zdCA9IHBhcnRzWzBdIHx8ICcnO1xuICAgICAgICAgICAgICAgICAgICBwb3J0ID0gcGFyc2VJbnQocGFydHNbMV0sIDEwKSB8fCA4MDgwO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+PSA0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHBhcnRzWzJdIHx8IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZCA9IHBhcnRzWzNdIHx8IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIENo4buJIGPDsyBob3N0XG4gICAgICAgICAgICAgICAgaG9zdCA9IGxpbmUudHJpbSgpO1xuICAgICAgICAgICAgICAgIHBvcnQgPSA4MDgwOyAvLyBEZWZhdWx0IHBvcnRcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gS2nhu4NtIHRyYSB4ZW0gY8OzIHByb3h5IHR5cGUga2jDtG5nIChzb2NrczU6Ly8uLi4pXG4gICAgICAgICAgICBpZiAoaG9zdC5pbmNsdWRlcygnOi8vJykpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IGhvc3Quc3BsaXQoJzovLycpO1xuICAgICAgICAgICAgICAgIHR5cGUgPSBwYXJ0c1swXSB8fCAnaHR0cCc7XG4gICAgICAgICAgICAgICAgaG9zdCA9IHBhcnRzWzFdIHx8ICcnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyDEkOG6o20gYuG6o28gZ2nDoSB0cuG7iyBo4bujcCBs4buHXG4gICAgICAgICAgICBob3N0ID0gaG9zdC50cmltKCk7XG4gICAgICAgICAgICBwb3J0ID0gcGFyc2VJbnQocG9ydCwgMTApIHx8IDgwODA7XG4gICAgICAgICAgICB1c2VybmFtZSA9IHVzZXJuYW1lID8gdXNlcm5hbWUudHJpbSgpIDogbnVsbDtcbiAgICAgICAgICAgIHBhc3N3b3JkID0gcGFzc3dvcmQgPyBwYXNzd29yZC50cmltKCkgOiBudWxsO1xuICAgICAgICAgICAgdHlwZSA9IHR5cGUudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgaWYgKCFob3N0KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHByb3h5IGZvcm1hdDogbWlzc2luZyBob3N0Jyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHsgaG9zdCwgcG9ydCwgdXNlcm5hbWUsIHBhc3N3b3JkLCB0eXBlLCBzdGF0dXM6ICdhY3RpdmUnIH07XG4gICAgICAgICAgICBsb2coJ+KchSBQYXJzZWQgcHJveHkgZGF0YTonLCByZXN1bHQpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGVycm9yKCfinYwgRXJyb3IgcGFyc2luZyBwcm94eSBsaW5lOicsIGVycm9yKTtcbiAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGJhc2ljIHByb3h5XG4gICAgICAgICAgICByZXR1cm4geyBcbiAgICAgICAgICAgICAgICBob3N0OiBsaW5lLnRyaW0oKSB8fCAnbG9jYWxob3N0JywgXG4gICAgICAgICAgICAgICAgcG9ydDogODA4MCwgXG4gICAgICAgICAgICAgICAgdXNlcm5hbWU6IG51bGwsIFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBudWxsLCBcbiAgICAgICAgICAgICAgICB0eXBlOiAnaHR0cCcsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnYWN0aXZlJ1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERpIGNodXnhu4NuIG5oaeG7gXUgcHJveHkgdsOgbyBt4buZdCBmb2xkZXJcbiAgICAgKi9cbiAgICBhc3luYyBidWxrTW92ZVByb3hpZXNUb0ZvbGRlcihwcm94eUlkcywgZm9sZGVySWQpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShwcm94eUlkcykgfHwgcHJveHlJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnRGFuaCBzw6FjaCBwcm94eSBraMO0bmcgaOG7o3AgbOG7hycgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbG9nKGDwn5SEIERpIGNodXnhu4NuICR7cHJveHlJZHMubGVuZ3RofSBwcm94eSB2w6BvIGZvbGRlciAke2ZvbGRlcklkfWApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgICAgICAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKGBcbiAgICAgICAgICAgICAgICBVUERBVEUgcHJveGllcyBcbiAgICAgICAgICAgICAgICBTRVQgZm9sZGVySWQgPSA/LCB1cGRhdGVkQXQgPSA/IFxuICAgICAgICAgICAgICAgIFdIRVJFIGlkIElOICgke3Byb3h5SWRzLm1hcCgoKSA9PiAnPycpLmpvaW4oJywnKX0pXG4gICAgICAgICAgICBgKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gW2ZvbGRlcklkLCBub3csIC4uLnByb3h5SWRzXTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHN0bXQucnVuKC4uLnBhcmFtcyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChyZXN1bHQuY2hhbmdlcyA+IDApIHtcbiAgICAgICAgICAgICAgICBsb2coYOKchSDEkMOjIGRpIGNodXnhu4NuICR7cmVzdWx0LmNoYW5nZXN9IHByb3h5IHbDoG8gZm9sZGVyICR7Zm9sZGVySWR9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsIFxuICAgICAgICAgICAgICAgICAgICBtb3ZlZDogcmVzdWx0LmNoYW5nZXMsXG4gICAgICAgICAgICAgICAgICAgIHRvdGFsOiBwcm94eUlkcy5sZW5ndGhcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwgXG4gICAgICAgICAgICAgICAgICAgIG1vdmVkOiAwLFxuICAgICAgICAgICAgICAgICAgICB0b3RhbDogcHJveHlJZHMubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnS2jDtG5nIGPDsyBwcm94eSBuw6BvIMSRxrDhu6NjIGRpIGNodXnhu4NuJ1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBlcnJvcignRXJyb3IgbW92aW5nIHByb3hpZXMgdG8gZm9sZGVyOicsIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGVzdCBuaGnhu4F1IHByb3h5IGPDuW5nIGzDumNcbiAgICAgKi9cbiAgICBhc3luYyBidWxrVGVzdFByb3hpZXMocHJveHlJZHMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShwcm94eUlkcykgfHwgcHJveHlJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnRGFuaCBzw6FjaCBwcm94eSBraMO0bmcgaOG7o3AgbOG7hycgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbG9nKGDwn5SEIEtp4buDbSB0cmEgJHtwcm94eUlkcy5sZW5ndGh9IHByb3h5YCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBbXTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcHJveHlJZCBvZiBwcm94eUlkcykge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMudGVzdFByb3h5KHByb3h5SWQpO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goeyBcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBwcm94eUlkLCBcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHJlc3VsdC5zdWNjZXNzLCBcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogcmVzdWx0LnN0YXR1cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlVGltZTogcmVzdWx0LnJlc3BvbnNlVGltZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goeyBpZDogcHJveHlJZCwgc3VjY2VzczogZmFsc2UsIGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3Qgc3VjY2Vzc0NvdW50ID0gcmVzdWx0cy5maWx0ZXIociA9PiByLnN1Y2Nlc3MgJiYgci5zdGF0dXMgPT09ICdhY3RpdmUnKS5sZW5ndGg7XG4gICAgICAgICAgICBsb2coYOKchSDEkMOjIGtp4buDbSB0cmEgJHtyZXN1bHRzLmxlbmd0aH0gcHJveHksICR7c3VjY2Vzc0NvdW50fSBob+G6oXQgxJHhu5luZyB04buRdGApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICAgICAgcmVzdWx0czogcmVzdWx0cyxcbiAgICAgICAgICAgICAgICB3b3JraW5nOiBzdWNjZXNzQ291bnQsXG4gICAgICAgICAgICAgICAgdG90YWw6IHJlc3VsdHMubGVuZ3RoXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgZXJyb3IoJ0Vycm9yIGJ1bGsgdGVzdGluZyBwcm94aWVzOicsIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogWHXhuqV0IGRhbmggc8OhY2ggcHJveHkgdGhlbyDEkeG7i25oIGThuqFuZ1xuICAgICAqL1xuICAgIGFzeW5jIGV4cG9ydFByb3hpZXMoZm9ybWF0ID0gJ2lwX3BvcnRfdXNlcm5hbWVfcGFzc3dvcmQnLCBwcm94eUlkcyA9IG51bGwpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCBzdG10O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwcm94eUlkcykgJiYgcHJveHlJZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIC8vIFh14bqldCBwcm94eSB0aGVvIGRh